name: Spec Generation Tests

on:
  push:
    branches: [main]
    paths:
      - '**/*.py'
      - 'Dockerfile'
      - 'pyproject.toml'
      - '.github/workflows/agent-generation-tests.yml'
      - 'tests/integration/docker-compose.test.yml'
  pull_request:
    branches: [main]
    paths:
      - '**/*.py'
      - 'Dockerfile'
      - 'pyproject.toml'
      - '.github/workflows/agent-generation-tests.yml'
      - 'tests/integration/docker-compose.test.yml'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  agent-generation-tests:
    name: Spec Generation Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Start Infrastructure Services
        run: |
          cd tests/integration
          docker compose -f docker-compose.test.yml up -d
          echo "Waiting for services to be healthy..."
          timeout 60 bash -c 'until docker compose -f docker-compose.test.yml ps | grep -q "healthy"; do sleep 2; done'
          docker compose -f docker-compose.test.yml ps
      
      - name: Run Database Migrations
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 15433
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
          POSTGRES_SCHEMA: public
          MIGRATION_DIR: ./migrations
        run: |
          # Wait for postgres to be ready
          until pg_isready -h localhost -p 15433 -U test_user; do sleep 1; done
          # Use the purpose-built migration script
          chmod +x scripts/ci/run-migrations.sh
          ./scripts/ci/run-migrations.sh
      
      - name: Start FastAPI Application
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 15433
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
          POSTGRES_SCHEMA: public
          DRAGONFLY_HOST: localhost
          DRAGONFLY_PORT: 16380
          REDIS_HOST: localhost
          REDIS_PORT: 16380
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Start FastAPI in background
          python -m uvicorn api.main:app --host 0.0.0.0 --port 8000 &
          APP_PID=$!
          echo "APP_PID=$APP_PID" >> $GITHUB_ENV
          
          # Wait for app to start
          timeout 30 bash -c 'until curl -f http://localhost:8000/health; do sleep 2; done'
          echo "FastAPI application started successfully"
      
      - name: Run Spec Generation Tests
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 15433
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
          POSTGRES_SCHEMA: public
          DRAGONFLY_HOST: localhost
          DRAGONFLY_PORT: 16380
          REDIS_HOST: localhost
          REDIS_PORT: 16380
          OPENAI_API_KEY: ${{ secrets.OPENAI_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          pytest tests/integration/test_agent_generation_workflow.py::test_agent_generation_end_to_end_success -v --tb=short --junit-xml=artifacts/test-results.xml
      
      - name: Stop FastAPI Application
        if: always()
        run: |
          if [ ! -z "$APP_PID" ]; then
            kill $APP_PID || true
          fi
      
      - name: Stop Infrastructure Services
        if: always()
        run: |
          cd tests/integration
          docker compose -f docker-compose.test.yml down -v
      
      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agent-generation-artifacts
          path: |
            tests/integration/outputs/
            artifacts/
          retention-days: 30
      
      - name: Parse test results
        if: always() && github.event_name == 'pull_request'
        id: parse_results
        run: |
          if [ -f artifacts/test-results.xml ]; then
            TESTS=$(grep -oP 'tests="\K[0-9]+' artifacts/test-results.xml | head -1)
            FAILURES=$(grep -oP 'failures="\K[0-9]+' artifacts/test-results.xml | head -1)
            ERRORS=$(grep -oP 'errors="\K[0-9]+' artifacts/test-results.xml | head -1)
            
            echo "tests=${TESTS:-0}" >> $GITHUB_OUTPUT
            echo "failures=${FAILURES:-0}" >> $GITHUB_OUTPUT
            echo "errors=${ERRORS:-0}" >> $GITHUB_OUTPUT
          else
            echo "tests=0" >> $GITHUB_OUTPUT
            echo "failures=0" >> $GITHUB_OUTPUT
            echo "errors=0" >> $GITHUB_OUTPUT
          fi
      
      - name: Comment PR with test results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const tests = '${{ steps.parse_results.outputs.tests }}';
            const failures = '${{ steps.parse_results.outputs.failures }}';
            const errors = '${{ steps.parse_results.outputs.errors }}';
            const passed = parseInt(tests) - parseInt(failures) - parseInt(errors);
            const success = parseInt(failures) === 0 && parseInt(errors) === 0;
            
            const emoji = success ? 'âœ…' : 'âŒ';
            const status = success ? 'PASSED' : 'FAILED';
            
            const body = `## ${emoji} Agent Generation Tests ${status}
            
            **Test Summary:**
            - Total Tests: ${tests}
            - Passed: ${passed}
            - Failed: ${failures}
            - Errors: ${errors}
            
            **Infrastructure:** Docker Compose (Postgres + Redis + NATS)
            
            ${success ? 'ğŸ‰ All agent generation tests passed!' : 'âš ï¸ Some tests failed. Please review the artifacts for details.'}
            
            [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });