name: In-Cluster Integration Tests

# ==============================================================================
# Reusable Workflow for In-Cluster Testing (Filesystem Contract)
# ==============================================================================
# This workflow uses the filesystem contract approach where services declare
# their requirements in ci/config.yaml and the platform handles execution.
#
# Usage in other workflows:
#   jobs:
#     integration-tests:
#       uses: ./.github/workflows/in-cluster-test.yml
# ==============================================================================

on:
  workflow_call:
    inputs:
      test-path:
        description: 'Path to the test file or directory to run'
        required: false
        type: string
        default: 'tests/integration'
      test-name:
        description: 'Name identifier for the test suite'
        required: false
        type: string
        default: 'integration-tests'
      timeout:
        description: 'Test timeout in seconds'
        required: false
        type: number
        default: 600
      use-real-llm:
        description: 'Whether to use real LLM APIs instead of mocks'
        required: false
        type: boolean
        default: false
    secrets:
      BOT_GITHUB_TOKEN:
        required: false
      BOT_GITHUB_USERNAME:
        required: false
      AWS_ROLE_ARN:
        required: false
      OPENAI_API_KEY:
        required: false
      ANTHROPIC_API_KEY:
        required: false

permissions:
  id-token: write      # Required for AWS OIDC authentication
  contents: read
  pull-requests: write

jobs:
  in-cluster-tests:
    name: In-Cluster Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.BOT_GITHUB_TOKEN || github.token }}
      
      - name: Read platform branch from config
        id: platform-config
        run: |
          # Read platform branch from ci/config.yaml
          if command -v yq &> /dev/null; then
            PLATFORM_BRANCH=$(yq eval '.platform.branch // "main"' ci/config.yaml)
          else
            # Fallback: basic grep parsing
            PLATFORM_BRANCH=$(grep -E '^\s*branch:' ci/config.yaml | sed 's/.*branch:\s*["\x27]*\([^"\x27]*\)["\x27]*.*/\1/' | tr -d ' ' || echo "main")
          fi
          echo "platform-branch=$PLATFORM_BRANCH" >> $GITHUB_OUTPUT
          echo "Using platform branch: $PLATFORM_BRANCH"
      
      - name: Checkout zerotouch-platform
        uses: actions/checkout@v4
        with:
          repository: 'arun4infra/zerotouch-platform'
          ref: ${{ steps.platform-config.outputs.platform-branch }}
          path: 'zerotouch-platform'
          token: ${{ secrets.BOT_GITHUB_TOKEN || github.token }}
      
      - name: Make platform scripts executable
        run: |
          # Make all shell scripts in the platform executable
          find zerotouch-platform/scripts -name "*.sh" -type f -exec chmod +x {} \;
          echo "Made platform scripts executable"
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-south-1
          mask-aws-account-id: true
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Run Centralized In-Cluster Test Script
        env:
          BOT_GITHUB_USERNAME: ${{ secrets.BOT_GITHUB_USERNAME }}
          BOT_GITHUB_TOKEN: ${{ secrets.BOT_GITHUB_TOKEN }}
          TENANTS_REPO_NAME: ${{ secrets.TENANTS_REPO_NAME }}
          TEST_PATH: ${{ inputs.test-path }}
          TEST_NAME: ${{ inputs.test-name }}
          TEST_TIMEOUT: ${{ inputs.timeout }}
          USE_REAL_LLM: ${{ inputs.use-real-llm }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Use centralized platform script with filesystem contract
          chmod +x zerotouch-platform/scripts/bootstrap/preview/tenants/scripts/in-cluster-test.sh
          ./zerotouch-platform/scripts/bootstrap/preview/tenants/scripts/in-cluster-test.sh
      
      - name: Cleanup
        if: always()
        run: |
          # Load config for cleanup
          NAMESPACE=$(yq eval '.service.namespace' ci/config.yaml 2>/dev/null || echo "default")
          TEST_NAME="integration-tests"
          
          # Get logs from failed pods for debugging
          if kubectl get pods -n "$NAMESPACE" -l test-suite="$TEST_NAME" --field-selector=status.phase=Failed -o name 2>/dev/null | grep -q .; then
            echo "=== Failed Pod Logs ==="
            kubectl get pods -n "$NAMESPACE" -l test-suite="$TEST_NAME" --field-selector=status.phase=Failed -o name | while read pod; do
              echo "--- Logs for $pod ---"
              kubectl logs "$pod" -n "$NAMESPACE" || true
            done
          fi
          
          # Clean up test jobs
          kubectl delete jobs -n "$NAMESPACE" -l test-suite="$TEST_NAME" --ignore-not-found=true || true
          
          # Clean up the Kind cluster
          kind delete cluster --name zerotouch-preview || true