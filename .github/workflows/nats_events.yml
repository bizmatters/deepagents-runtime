name: NATS Events Integration Tests

on:
  push:
    branches: [main]
    paths:
      - '**/*.py'
      - 'Dockerfile'
      - 'pyproject.toml'
      - 'platform/claims/**'
      - '.github/workflows/deepagnets-integration-tests.yml'
      - 'scripts/ci/**'
      - 'tests/integration/**'
  pull_request:
    branches: [main]
    paths:
      - '**/*.py'
      - 'Dockerfile'
      - 'pyproject.toml'
      - 'platform/claims/**'
      - '.github/workflows/deepagnets-integration-tests.yml'
      - 'scripts/ci/**'
      - 'tests/integration/**'
  schedule:
    # Run daily at 2 AM UTC to test against latest platform changes
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      platform_branch:
        description: 'zerotouch-platform branch to test against'
        required: false
        default: 'main'
        type: string

permissions:
  id-token: write      # Required for AWS OIDC authentication
  contents: read       # Required to checkout repository
  pull-requests: write # Required to comment on PRs

jobs:
  nats-events-tests:
    name: Run NATS Events Tests
    runs-on: ubuntu-latest  # 4 CPU, 16GB RAM for platform setup
    timeout-minutes: 45
    
    steps:
      - name: Checkout deepagents-runtime
        uses: actions/checkout@v4
        with:
          path: deepagents-runtime
      
      - name: Clone zerotouch-platform
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/zerotouch-platform
          ref: ${{ inputs.platform_branch || 'main' }}
          path: zerotouch-platform
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-south-1
          mask-aws-account-id: true
      
      - name: Export AWS credentials as environment variables
        run: |
          echo "AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY" >> $GITHUB_ENV
          echo "AWS_SESSION_TOKEN=$AWS_SESSION_TOKEN" >> $GITHUB_ENV
          # Mask credentials in logs
          echo "::add-mask::$AWS_ACCESS_KEY_ID"
          echo "::add-mask::$AWS_SECRET_ACCESS_KEY"
          echo "::add-mask::$AWS_SESSION_TOKEN"
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install Python Dependencies
        working-directory: deepagents-runtime
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Bootstrap Platform Preview Environment
        working-directory: zerotouch-platform
        env:
          BOT_GITHUB_USERNAME: ${{ secrets.BOT_GITHUB_USERNAME }}
          BOT_GITHUB_TOKEN: ${{ secrets.BOT_GITHUB_TOKEN }}
        run: |
          chmod +x scripts/bootstrap/01-master-bootstrap.sh
          ./scripts/bootstrap/01-master-bootstrap.sh --mode preview
      
      - name: Build Docker Image
        working-directory: deepagents-runtime
        run: |
          chmod +x scripts/ci/build.sh
          ./scripts/ci/build.sh --mode=test
      
      - name: Apply Preview Patches
        working-directory: deepagents-runtime
        run: |
          chmod +x scripts/patches/00-apply-all-patches.sh
          ./scripts/patches/00-apply-all-patches.sh --force
      
      - name: Pre-Deploy Diagnostics
        if: always()
        working-directory: deepagents-runtime
        run: |
          chmod +x scripts/ci/pre-deploy-diagnostics.sh
          ./scripts/ci/pre-deploy-diagnostics.sh
      
      - name: Deploy Service
        working-directory: deepagents-runtime
        env:
          ZEROTOUCH_PLATFORM_DIR: ${{ github.workspace }}/zerotouch-platform
        run: |
          chmod +x scripts/ci/deploy.sh
          ./scripts/ci/deploy.sh preview
      
      - name: Post-Deploy Diagnostics
        if: always()
        working-directory: deepagents-runtime
        run: |
          chmod +x scripts/ci/post-deploy-diagnostics.sh
          ./scripts/ci/post-deploy-diagnostics.sh intelligence-deepagents deepagents-runtime
      
      - name: Run NATS Events Integration Tests
        id: run_tests
        working-directory: deepagents-runtime
        env:
          ZEROTOUCH_PLATFORM_DIR: ${{ github.workspace }}/zerotouch-platform
          USE_MOCK_LLM: "true"  # NATS tests use mocked ExecutionManager (no real LLM calls)
          MOCK_TIMEOUT: "60"    # Fast timeout for mock execution
          # Note: This test focuses on NATS infrastructure, not agent generation
        run: |
          chmod +x scripts/ci/test.sh
          ./scripts/ci/test.sh tests/integration/test_nats_events_integration.py
      
      - name: Cleanup Preview Environment
        if: always()
        working-directory: zerotouch-platform
        run: |
          chmod +x scripts/bootstrap/cleanup-preview.sh
          ./scripts/bootstrap/cleanup-preview.sh
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            deepagents-runtime/artifacts/test-results.xml
            deepagents-runtime/artifacts/coverage.xml
            deepagents-runtime/artifacts/htmlcov/
          retention-days: 30
      
      - name: Upload test outputs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-outputs
          path: |
            deepagents-runtime/tests/integration/outputs/run_*/
          retention-days: 30
      
      - name: Upload debugging artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-artifacts
          path: |
            deepagents-runtime/artifacts/pods.txt
            deepagents-runtime/artifacts/keda-scaledobjects.txt
            deepagents-runtime/artifacts/crossplane-claims.txt
            deepagents-runtime/artifacts/deepagents-runtime-logs.txt
          retention-days: 30
      
      - name: Parse test results
        if: always() && github.event_name == 'pull_request'
        id: parse_results
        run: |
          if [ -f deepagents-runtime/artifacts/test-results.xml ]; then
            # Extract test summary from JUnit XML
            TESTS=$(grep -oP 'tests="\K[0-9]+' deepagents-runtime/artifacts/test-results.xml | head -1)
            FAILURES=$(grep -oP 'failures="\K[0-9]+' deepagents-runtime/artifacts/test-results.xml | head -1)
            ERRORS=$(grep -oP 'errors="\K[0-9]+' deepagents-runtime/artifacts/test-results.xml | head -1)
            
            echo "tests=${TESTS:-0}" >> $GITHUB_OUTPUT
            echo "failures=${FAILURES:-0}" >> $GITHUB_OUTPUT
            echo "errors=${ERRORS:-0}" >> $GITHUB_OUTPUT
          else
            echo "tests=0" >> $GITHUB_OUTPUT
            echo "failures=0" >> $GITHUB_OUTPUT
            echo "errors=0" >> $GITHUB_OUTPUT
          fi
      
      - name: Comment PR with test results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const tests = '${{ steps.parse_results.outputs.tests }}';
            const failures = '${{ steps.parse_results.outputs.failures }}';
            const errors = '${{ steps.parse_results.outputs.errors }}';
            const passed = parseInt(tests) - parseInt(failures) - parseInt(errors);
            const success = parseInt(failures) === 0 && parseInt(errors) === 0;
            
            const emoji = success ? 'âœ…' : 'âŒ';
            const status = success ? 'PASSED' : 'FAILED';
            
            const body = `## ${emoji} Integration Tests ${status}
            
            **Test Summary:**
            - Total Tests: ${tests}
            - Passed: ${passed}
            - Failed: ${failures}
            - Errors: ${errors}
            
            **Platform Branch:** \`${{ inputs.platform_branch || 'main' }}\`
            
            ${success ? 'ğŸ‰ All integration tests passed!' : 'âš ï¸ Some tests failed. Please review the artifacts for details.'}
            
            [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
